<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LASURA Property Ground-Truthing Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <style>

 
    
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f9fa;
    }
    h2 {
      color: #343a40;
    }
    select, input, button {
      margin: 5px 0;
      padding: 8px;
      width: 100%;
    }
    .progress-container {
      background-color: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar {
      background-color: #28a745;
      height: 20px;
      width: 0%;
      color: white;
      text-align: center;
    }
    #map {
      width: 100%;
      height: 300px;
      background-color: #dcdcdc;
      margin: 10px 0;
    }
    .record-tile {
    
      border-radius: 10px;
      padding: 10px;
      margin: 5px;
      color: white;
      display: grid;
      width: 10px;
      height: 10px;
      grid-template-column: repeat(10, 1fr);
   
   
      text-align: center;
    }
    .verified {
      background-color: #28a745;
    }
    .unverified {
      background-color: #dc3545;
    }

    #batchOverview{
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <h2>LASURA Property Ground-Truthing Dashboard</h2>

  <div>
    <label for="batchSelect">Select Batch:</label>
    <select id="batchSelect" onchange="loadRecords()"></select>
  </div>

  <div style="margin-top: 10px;">
    <input type="text" id="searchInput" placeholder="Search by property location" style="padding: 6px; width: 60%;">
    <button id="searchButton" style="padding: 6px 10px; background-color: #007bff; color: white; border: none; cursor: pointer;">Search</button>
    <button id="resetButton" style="padding: 6px 10px; margin-left: 5px; background-color: #6c757d; color: white; border: none; cursor: pointer;">Reset</button>
  </div>

  <div>
    <label for="recordSelect">Select Record to Verify:</label>
    <select id="recordSelect" onchange="displayRecordInfo()"></select>
  </div>

  <div id="recordInfo">
    <p><strong>Subject Matter:</strong> <span id="subject"></span></p>
    <p><strong>Property Location:</strong> <span id="propertyLocation"></span></p>
    <p><strong>New Address (Optional):</strong></p>
    <input type="text" id="newAddressInput" placeholder="Enter new address" />
    <p><strong>Saved New Address:</strong> <span id="savedNewAddress"></span></p>
  </div>

  <div>
    <button onclick="captureLocation()">Capture GPS</button>
    <p>Latitude: <span id="latitude"></span> | Longitude: <span id="longitude"></span></p>
  </div>

  <div>
    <input type="file" id="photoUpload" accept="image/*" multiple />
  </div>

  <div>
    <button onclick="saveVerification()">Save Verification</button>
  </div>

  <div class="progress-container">
    <div id="progressBar" class="progress-bar">0%</div>
  </div>

  <div id="batchOverview"></div>

  <script>
    const SUPABASE_URL = "https://bjflekkcgmpcjliizaii.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZmxla2tjZ21wY2psaWl6YWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzA1ODIsImV4cCI6MjA3NTQwNjU4Mn0.xi9LrQuEcRcy-aMSemD8mEII6iKg91L9eqGy8Hpaueo";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allRecords = [];
    let selectedRecord = null;
    let selectedPhotos = [];

    async function loadRecords() {
      const { data, error } = await supabaseClient
        .from('property_records')
        .select('*')
        .order('file_number', { ascending: true });

      if (error) {
        alert('Error loading records');
        console.error(error);
        return;
      }

      allRecords = data;
      populateDropdown(data);
      updateProgress(data);
      renderBatchOverview(data);
    }

    function populateDropdown(records) {
      const recordSelect = document.getElementById('recordSelect');
      recordSelect.innerHTML = '<option value="">Select Record to Verify</option>';

      records.forEach(record => {
        const option = document.createElement('option');
        option.value = record.id;
        option.textContent = record.property_location;
        recordSelect.appendChild(option);
      });
    }

    document.getElementById('searchButton').addEventListener('click', () => {
      const searchValue = document.getElementById('searchInput').value.toLowerCase().trim();
      if (!searchValue) {
        alert('Enter a location to search');
        return;
      }
      const filtered = allRecords.filter(record =>
        record.property_location && record.property_location.toLowerCase().includes(searchValue)
      );
      populateDropdown(filtered);
    });

    document.getElementById('resetButton').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      populateDropdown(allRecords);
    });

    function displayRecordInfo() {
      const recordId = document.getElementById('recordSelect').value;
      selectedRecord = allRecords.find(r => r.id == recordId);
      if (!selectedRecord) return;
      document.getElementById('subject').textContent = selectedRecord.subject || '';
      document.getElementById('propertyLocation').textContent = selectedRecord.property_location || '';
      document.getElementById('savedNewAddress').textContent = selectedRecord.new_address || '';
    }

    function captureLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          document.getElementById('latitude').textContent = position.coords.latitude;
          document.getElementById('longitude').textContent = position.coords.longitude;
        });
      } else {
        alert('Geolocation is not supported by this browser.');
      }
    }

    async function saveVerification() {
      if (!selectedRecord) {
        alert('Please select a record first.');
        return;
      }

      const latitude = parseFloat(document.getElementById('latitude').textContent);
      const longitude = parseFloat(document.getElementById('longitude').textContent);
      const newAddress = document.getElementById('newAddressInput').value;
      const files = document.getElementById('photoUpload').files;

      if (!latitude || !longitude) {
        alert('Capture GPS before saving.');
        return;
      }

      const [easting, northing] = proj4('EPSG:4326', 'EPSG:26331', [longitude, latitude]);

      const photoUrls = [];
      for (let file of files) {
        const { data: uploadedFile, error } = await supabase.storage
          .from('groundtruth_photos')
          .upload(`record_${selectedRecord.id}/${file.name}`, file, { upsert: true });

        if (!error) {
          const { data: publicUrlData } = supabase.storage
            .from('groundtruth_photos')
            .getPublicUrl(uploadedFile.path);
          photoUrls.push(publicUrlData.publicUrl);
        }
      }

      const { error } = await supabase
        .from('property_records')
        .update({
          latitude,
          longitude,
          easting,
          northing,
          photo_urls: photoUrls,
          verified_by: 'Officer',
          new_address: newAddress,
        })
        .eq('id', selectedRecord.id);

      if (error) {
        alert('Error saving record');
        console.error(error);
      } else {
        alert('Record saved successfully!');
        document.getElementById('savedNewAddress').textContent = newAddress;
        loadRecords();
      }
    }

    function updateProgress(records) {
      const verifiedCount = records.filter(r => r.photo_urls && r.photo_urls.length > 0).length;
      const total = records.length;
      const percent = total ? Math.round((verifiedCount / total) * 100) : 0;
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
    }

    function renderBatchOverview(records) {
      const container = document.getElementById('batchOverview');
      container.innerHTML = '';

      records.forEach(record => {
        const tile = document.createElement('div');
        tile.classList.add('record-tile');
        tile.classList.add(record.photo_urls && record.photo_urls.length > 0 ? 'verified' : 'unverified');
        tile.innerHTML = `<strong>${record.id}`;
        container.appendChild(tile);
      });
    }

    loadRecords();
  </script>
</body>
</html>
















