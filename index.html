<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LASURA Property Ground-Truthing Dashboard</title>

  <!-- Supabase + Proj4 libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.1/dist/proj4.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; color: #0078d7; }
    label { font-weight: bold; }
    #progressBarContainer { width: 90%; margin: 0 auto 10px; height: 10px; background:#e0e0e0; border-radius:5px; }
    #progressBar { height:10px; width:0%; background:#0078d7; border-radius:5px; }
    #batchList div { min-width:40px; text-align:center; font-weight:600; color:#fff; border-radius:5px; padding:6px 8px; cursor:pointer; }
    #previewContainer img { width:70px; height:70px; object-fit:cover; border:1px solid #ccc; border-radius:4px; margin:3px; }
    #status { text-align:center; margin-top:10px; font-weight:bold; }
  </style>
</head>

<body>
  <h2>üèóÔ∏è LASURA Property Ground-Truthing Dashboard</h2>

  <!-- Progress summary -->
  <p id="progressSummary" style="text-align:center;font-weight:bold;color:#0078d7;margin-bottom:5px;">
    Loading progress‚Ä¶
  </p>
  <div id="progressBarContainer">
    <div id="progressBar"></div>
  </div>

  <!-- Batch overview -->
  <div id="batchSummary" style="margin-top:10px;text-align:center;">
    <h3 style="font-size:16px;">Batch Overview</h3>
    <div id="batchList" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;"></div>
  </div>

  <br/>

  <!-- Batch filter -->
  <label>Filter by Batch:</label>
  <select id="batchFilter">
    <option value="">-- All Batches --</option>
  </select>

  <br/><br/>

  <!-- Record selection -->
  <label>Select Property Record:</label>
  <select id="recordSelect">
    <option value="">-- Select Record --</option>
  </select>
  <!-- Record details section -->
<div id="recordDetails" style="margin-top:10px;display:none;border:1px solid #ddd;padding:8px;border-radius:5px;background:#f9f9f9;">
  <p><strong>üè† Subject Matter:</strong> <span id="subjectMatter">‚Äî</span></p>
  <p><strong>üìç Property Location:</strong> <span id="propertyLocation">‚Äî</span></p>
</div>

  <br/><br/>

  <!-- Officer name -->
  <label>Verified By (required):</label>
  <input id="verifier" placeholder="Enter your full name" required autocomplete="name" />

  <br/><br/>

  <!-- Multi-photo input -->
  <label>üì∏ Take/Upload Photos:</label>
  <input type="file" id="photoInput" accept="image/*" multiple capture="environment" />
  <div id="previewContainer" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:5px;"></div>

  <br/>
  <button id="captureBtn">üìç Capture GPS Location</button>
  <button id="saveBtn">üíæ Save Verification</button>

  <p id="status"></p>

  <!-- ========================== SCRIPT SECTION =========================== -->
  <script>
  const SUPABASE_URL = "https://bjflekkcgmpcjliizaii.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZmxla2tjZ21wY2psaWl6YWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzA1ODIsImV4cCI6MjA3NTQwNjU4Mn0.xi9LrQuEcRcy-aMSemD8mEII6iKg91L9eqGy8Hpaueo";
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // === Global references ===
  const recordSelect = document.getElementById("recordSelect");
  const batchFilter = document.getElementById("batchFilter");
  const verifierInput = document.getElementById("verifier");
  const statusMsg = document.getElementById("status");
  const photoInput = document.getElementById("photoInput");
  const previewContainer = document.getElementById("previewContainer");
  let selectedRecord = null, lat = null, lon = null, selectedPhotos = [];

  // === Define projections ===
  proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
  proj4.defs("EPSG:26331", "+proj=utm +zone=31 +ellps=clrk80 +towgs84=93.07,89.39,123.12,0,0,0,0 +units=m +no_defs");
  function toMinnaUTM(lat, lon) {
    const [x, y] = proj4("EPSG:4326", "EPSG:26331", [lon, lat]);
    return { easting: x, northing: y };
  }

  // === Preview multiple photos ===
  photoInput.addEventListener("change", () => {
    previewContainer.innerHTML = "";
    selectedPhotos = Array.from(photoInput.files);
    selectedPhotos.forEach(file => {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      previewContainer.appendChild(img);
    });
  });

  // === Capture GPS ===
  document.getElementById("captureBtn").onclick = () => {
    if (!navigator.geolocation) return alert("Geolocation not supported.");
    navigator.geolocation.getCurrentPosition(pos => {
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;
      alert(`üìç Location captured!\nLatitude: ${lat}\nLongitude: ${lon}`);
    }, err => alert("Unable to get location: " + err.message));
  };

  // === Upload multiple photos ===
  async function uploadPhotos(files, recordId) {
    const urls = [];
    const bucket = "groundtruth_photos"; // ensure this bucket exists
    for (const file of files) {
      const uniqueName = `${recordId}_${Date.now()}_${file.name}`;
      const { data, error } = await supabaseClient.storage
        .from(bucket)
        .upload(`record_${recordId}/${uniqueName}`, file, { upsert: false });
      if (error) throw error;
      const { data: publicUrlData } = supabaseClient
        .storage.from(bucket)
        .getPublicUrl(`record_${recordId}/${uniqueName}`);
      urls.push(publicUrlData.publicUrl);
    }
    return urls;
  }

  // === Save verification ===
  document.getElementById("saveBtn").addEventListener("click", async () => {
    try {
      if (!selectedRecord) return alert("Select a record first.");
      if (lat === null || lon === null) return alert("Please capture GPS location.");
      const verifier = (verifierInput.value || "").trim();
      if (!verifier) return alert("Please enter your name in 'Verified By'.");
      if (selectedPhotos.length === 0) return alert("Please select at least one photo.");

      // Check if already verified
      const { data: existing } = await supabaseClient
        .from("property_records")
        .select("photo_urls,latitude,longitude")
        .eq("id", selectedRecord.id).single();
      if (existing && (existing.photo_urls?.length || (existing.latitude && existing.longitude))) {
        return alert("‚ö†Ô∏è This record has already been verified and cannot be modified.");
      }

      statusMsg.textContent = "Uploading photos‚Ä¶";
      const photoUrls = await uploadPhotos(selectedPhotos, selectedRecord.id);

      statusMsg.textContent = "Saving data‚Ä¶";
      const { easting, northing } = toMinnaUTM(lat, lon);
      const { error: updateError } = await supabaseClient
        .from("property_records")
        .update({
          latitude: lat,
          longitude: lon,
          easting: easting,
          northing: northing,
          photo_urls: photoUrls,
          verified_by: verifier
        })
        .eq("id", selectedRecord.id);
      if (updateError) throw updateError;

      statusMsg.textContent = "‚úÖ Record verified successfully!";
      setTimeout(() => (statusMsg.textContent = ""), 4000);
      loadRecords(batchFilter.value);
    } catch (err) {
      console.error(err);
      statusMsg.textContent = "‚ùå " + err.message;
    }
  });

  // === Populate batches ===
  function populateBatchFilter(data) {
    const uniqueBatches = [...new Set(data.map(r => r.batch_no).filter(Boolean))].sort((a,b)=>a-b);
    batchFilter.innerHTML = "<option value=''>-- All Batches --</option>";
    uniqueBatches.forEach(batch => {
      const opt = document.createElement("option");
      opt.value = batch;
      opt.textContent = `Batch ${batch}`;
      batchFilter.appendChild(opt);
    });
  }

  // === Load records + progress ===
  async function loadRecords(selectedBatch = "") {
    try {
      const query = supabaseClient
        .from("property_records")
        .select("id,file_number,property_location,batch_no,latitude,longitude,photo_urls")
        .order("id", { ascending: true });
      if (selectedBatch) query.eq("batch_no", selectedBatch);
      const { data, error } = await query;
      if (error) throw error;

      const total = data.length;
      const verified = data.filter(r => r.photo_urls?.length || (r.latitude && r.longitude)).length;
      const percent = total ? ((verified / total) * 100).toFixed(1) : 0;

      const label = selectedBatch
        ? `Batch ${selectedBatch}: ‚úÖ ${verified} verified / ${total} total (${percent}%)`
        : `All Batches: ‚úÖ ${verified} verified / ${total} total (${percent}%)`;
      document.getElementById("progressSummary").textContent = label;
      document.getElementById("progressBar").style.width = percent + "%";

      const recordSelect = document.getElementById("recordSelect");
      recordSelect.innerHTML = "<option value=''>-- Select Record --</option>";
     data.forEach(rec => {
       const opt = document.createElement("option");
       opt.value = rec.id;
       opt.textContent = rec.file_number; // show only file_number
       recordSelect.appendChild(opt);
});

      if (!selectedBatch) populateBatchFilter(data);

      const batchList = document.getElementById("batchList");
      batchList.innerHTML = "";
      data.forEach(rec => {
        const done = rec.photo_urls?.length || (rec.latitude && rec.longitude);
        const tile = document.createElement("div");
        tile.textContent = rec.id;
        tile.style.background = done ? "#28a745" : "#dc3545";
        tile.title = rec.file_number;
        tile.onclick = () => {
          recordSelect.value = rec.id;
          recordSelect.dispatchEvent(new Event("change"));
          window.scrollTo({ top: 200, behavior: "smooth" });
        };
        batchList.appendChild(tile);
      });
    } catch (err) {
      console.error(err);
      alert("Error loading records: " + err.message);
    }
  }

  // === Handle record selection ===
  recordSelect.addEventListener("change", async (e) => {
  const id = e.target.value;
  const detailsBox = document.getElementById("recordDetails");
  const subjectSpan = document.getElementById("subjectMatter");
  const locationSpan = document.getElementById("propertyLocation");

  if (!id) {
    detailsBox.style.display = "none";
    subjectSpan.textContent = "‚Äî";
    locationSpan.textContent = "‚Äî";
    return;
  }

  const { data, error } = await supabaseClient
    .from("property_records")
    .select("*").eq("id", id).single();
  if (error) return console.error(error);
  selectedRecord = data;

  // Show details
  detailsBox.style.display = "block";
  subjectSpan.textContent = data.subject_matter || "‚Äî";
  locationSpan.textContent = data.property_location || "‚Äî";

  // Display existing photos
  previewContainer.innerHTML = "";
  if (data.photo_urls && data.photo_urls.length) {
    data.photo_urls.forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      previewContainer.appendChild(img);
    });
  }
});


  // === Batch filter change ===
  batchFilter.addEventListener("change", (e) => loadRecords(e.target.value));

  // === Initial load ===
  loadRecords();
  </script>
</body>
</html>

